name: Build Runtime
permissions:
  contents: write
on:
  release:
    types: 
      - published
  push:
    branches:
      - rust-std

  workflow_dispatch:
env:
  CARGO_TERM_COLOR: always

jobs:

  build-runtime:
    strategy:
      matrix:
        os:
          - ubuntu-20.04
          - ubuntu-22.04
          - windows-2019
          - windows-2022
          - macos-11
          - macos-12
    runs-on: ${{ matrix.os }}
    env:
      TARGET_DIR: ${{ github.workspace }}/luminary_runtime-${{ matrix.os }}-${{github.ref_name}}
      COMP_SUFFIX: ${{ startsWith(matrix.os, 'windows') && '7z' || 'tar.gz' }}
    steps:
    - uses: actions/checkout@v4
    - name: build runtime libs
      id: build-runtime
      run: >-
        cargo clean &&
        cargo build --release -p luminary-runtime --features runtime --lib
    - name: find files Windows
      if: runner.os == 'Windows'
      shell: bash
      run: >-
        mkdir $TARGET_DIR
        && ls . && ls ./target/release
        && cp ./target/release/luminary_runtime.lib $TARGET_DIR/luminary_runtime.lib
        && cp ./target/release/luminary_runtime.dll $TARGET_DIR/luminary_runtime.dll
        && 7z a -mx9 "$TARGET_DIR.$COMP_SUFFIX" $TARGET_DIR
    - name: find files Macos
      if: runner.os == 'Macos'
      shell: bash
      run: >-
        mkdir -p $TARGET_DIR
        && ls . && ls ./target/release
        && cp ./target/release/libluminary_runtime.a $TARGET_DIR/libluminary_runtime.a
        && cp ./target/release/libluminary_runtime.dylib $TARGET_DIR/libluminary_runtime.dylib
        && tar -czf $TARGET_DIR.$COMP_SUFFIX $TARGET_DIR
    - name: find files Linux
      if: runner.os == 'Linux'
      shell: bash
      run: >-
        mkdir -p $TARGET_DIR
        && ls ./target/release
        && cp ./target/release/libluminary_runtime.a $TARGET_DIR/libluminary_runtime.a
        && cp ./target/release/libluminary_runtime.so $TARGET_DIR/libluminary_runtime.so
        && tar -czf $TARGET_DIR.$COMP_SUFFIX $TARGET_DIR
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: libs
        path: ${{ env.TARGET_DIR }}.${{ env.COMP_SUFFIX }}
        overwrite: true
  # update-release:
  #   needs:
  #     - build-runtime
  #   runs-on: "ubuntu-20.04"
  #   env:
  #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #   steps:
  #     - uses: actions/checkout@v4
      # - name: "Download Github Artifacts"
      #   uses: actions/download-artifact@v3
      #   with:
      #     name: staticlib
      #     path: artifacts
      # - name: Create Github Release
      #   uses: ncipollo/release-action@v1
      #   with:
      #     allowUpdates: true
      #     tag: ${{ needs.plan.outputs.tag }}
      #     artifacts: "artifacts/*"
